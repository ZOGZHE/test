# IQGears 关卡生成系统使用指南（全新版本）

## 📦 系统概述

这是一个**全新升级**的自动化关卡生成系统，采用**反向设计法**创建高质量、有趣的齿轮puzzle关卡。

### 核心改进 🆕

相比旧版本，新系统解决了以下问题：
- ❌ ~~随机放置导致的冗余方块~~
- ❌ ~~解法过于简单或有多种解~~
- ❌ ~~未充分利用齿轮动态配置~~
- ❌ ~~缺少关卡质量评估~~

**新系统特性：**
- ✅ **智能路径规划**：创造有趣的弯曲路径，而非直线
- ✅ **精确方块配置**：用最少方块覆盖路径，无冗余
- ✅ **齿轮动态优化**：智能启用/禁用齿轮，增加解谜难度
- ✅ **解法唯一性验证**：确保没有多余的暴力解法
- ✅ **关卡质量评估**：只生成70+分的高质量关卡
- ✅ **有趣的地形**：十字形、菱形、L形等多样化网格

---

## 🚀 快速开始

### 1. 打开关卡生成器窗口

在Unity编辑器菜单栏选择：
```
Tools → Level Generator
```

### 2. 选择生成模式

**单个生成模式**：
- 输入关卡序号（如：8）
- 点击"生成单个关卡"
- 系统会尝试多次生成，直到找到高质量关卡

**批量生成模式**：
- 输入起始和结束关卡序号（如：1 到 50）
- 点击"批量生成关卡"
- 等待生成完成（新系统可能需要更长时间，但质量更高）

### 3. 查看生成的关卡

- 在Project窗口导航到 `Assets/Data/LevelData/`
- 双击 `LevelData_N.asset` 查看关卡配置
- 检查Console输出的质量评分

---

## 📁 新系统文件结构

```
Assets/Script/
├── LevelGeneration/          (关卡生成系统)
│   ├── BlockShapeDefinition.cs      # 方块形状定义（6种）
│   ├── PathValidator.cs             # BFS连通性验证器
│   ├── DifficultyProgression.cs     # 优化的难度曲线
│   ├── LevelGeneratorCore.cs        # 🆕 核心生成器（反向设计法）
│   ├── PathPlanner.cs               # 🆕 智能路径规划
│   ├── BlockPuzzleSolver.cs         # 🆕 方块拼图求解器
│   ├── GearConfigOptimizer.cs       # 🆕 齿轮配置优化器
│   ├── SolutionValidator.cs         # 🆕 解法验证器
│   ├── LevelQualityEvaluator.cs     # 🆕 质量评估系统
│   └── README_LevelGenerator.md     # 本文档
└── Editor/
    ├── LevelAssetCreator.cs         # Unity asset文件创建
    └── LevelGeneratorWindow.cs      # 编辑器窗口界面
```

---

## 🎮 新难度递增设计

系统为50+关卡提供科学的难度曲线：

| 关卡范围 | 难度等级 | 网格大小 | 动力/目标 | 方块数 | 特点 |
|---------|---------|---------|----------|-------|------|
| 1-10    | 教程    | 3x3     | 1/1      | 2-3   | 只有直线方块，无缺口 |
| 11-20   | 简单    | 4x4     | 1/1-2    | 2-4   | 引入L形和小缺口 |
| 21-30   | 中等    | 5x5     | 1/2-3    | 3-5   | T形方块，齿轮开关 |
| 31-40   | 困难    | 5x5-6x6 | 1-2/3-4  | 4-6   | 十字形，复杂配置 |
| 41-50   | 专家    | 6x6-7x7 | 2/4-5    | 5-7   | 大网格，精密设计 |
| 51+     | 大师    | 7x7-8x8 | 2-3/5-6  | 6-8   | 极限挑战 |

---

## 🔧 新系统生成流程

### 反向设计法 8步流程

```
第1步：初始化网格
  └─ 创造有趣形状（十字、菱形、L形等）

第2步：放置特殊元素
  └─ 动力轮优先边缘，目标轮保持距离

第3步：规划齿轮路径 🆕
  └─ 使用改进A*算法设计弯曲路径

第4步：方块拼图化 🆕
  └─ 贪心算法找最少方块覆盖路径

第5步：优化齿轮配置 🆕
  └─ 智能启用/禁用每个齿轮

第6步：验证解法唯一性 🆕
  └─ 检查冗余方块和替代解

第7步：最终验证
  └─ BFS验证连通性

第8步：质量评估 🆕
  └─ 5维度评分，只返回70+分关卡
```

---

## 🎯 关卡质量评估系统

新系统从5个维度评估关卡：

### 1. 拼图复杂度（25%）
- 方块数量适中
- 方块类型多样
- 使用复杂方块（L形、T形、十字形）
- 齿轮配置复杂度

### 2. 路径趣味性（20%）
- 路径有转弯和弯曲
- 覆盖网格多个区域
- 路径长度适中

### 3. 解法唯一性（30%）⭐ 最重要
- 无冗余方块
- 方块利用率高
- 解法紧凑

### 4. 难度平衡（15%）
- 符合预期难度
- 方块数量合理
- 路径长度匹配难度

### 5. 布局美观度（10%）
- 齿轮分布均匀
- 方块分布合理
- 网格形状有趣

**评分标准：**
- 70+分：高质量关卡（直接返回）
- 50-70分：可接受关卡（保留最佳）
- 50分以下：拒绝（重新生成）

---

## 🛠️ 核心算法详解

### 1. PathPlanner - 路径规划器

**改进A*算法特点：**
- 不走最短路径，增加随机性
- 创造转弯和弯曲
- 避免路径重叠
- 控制路径长度范围

### 2. BlockPuzzleSolver - 方块拼图求解器

**贪心策略：**
- 优先使用复杂方块（十字形、T形）
- 每次选择覆盖最多未覆盖位置的方块
- 确保完全覆盖路径
- 最小化多余覆盖

### 3. GearConfigOptimizer - 齿轮配置优化器

**智能优化：**
- 只启用路径上必需的齿轮
- 禁用80%的非必需齿轮
- 保留连接点的齿轮
- 验证并修复连通性

### 4. SolutionValidator - 解法验证器

**唯一性检查：**
- 检测冗余方块（移除后仍可解）
- 采样检查替代解（30次随机变换）
- 允许1-3个替代解
- 拒绝过多替代解

---

## 📝 使用技巧

### 生成时间预期

新系统质量优先，生成时间较长：
- **教程关卡（1-10）**：3-10秒/个
- **简单关卡（11-20）**：10-30秒/个
- **中等关卡（21-30）**：30-60秒/个
- **困难关卡（31-40）**：1-3分钟/个
- **专家关卡（41-50）**：2-5分钟/个

**批量生成50关预计：30-90分钟**

### 推荐生成策略

**分批生成并测试：**
1. 第一批：关卡 1-10（教程）→ 测试基础功能
2. 第二批：关卡 11-20（简单）→ 验证难度曲线
3. 第三批：关卡 21-30（中等）→ 测试齿轮配置
4. 第四批：关卡 31-40（困难）→ 验证复杂关卡
5. 第五批：关卡 41-50（专家）→ 最终挑战

### 查看质量报告

生成完成后，Console会显示：
```
[新生成器] 关卡 8 生成成功!
总分: 78.5/100
  拼图复杂度: 72.3
  路径趣味性: 65.8
  解法唯一性: 85.2
  难度平衡: 80.0
  布局美观: 70.5
```

---

## ⚠️ 注意事项

### 生成可能失败的情况

即使尝试100次，某些配置仍可能无法生成高质量关卡：
- 网格太小，约束太多
- 难度参数冲突
- 方块类型不足

**解决方案：**
- 检查Console的警告信息
- 调整DifficultyProgression.cs中的参数
- 降低质量要求（修改评估器阈值）

### 与旧系统的兼容性

新系统生成的LevelData与旧系统完全兼容，但具有以下优势：
- ✅ 齿轮配置更精确（gear1-gear4按需启用）
- ✅ 方块数量更合理（无冗余）
- ✅ 地形更多样化（各种形状）
- ✅ 解法更唯一（需要思考）

---

## 🔍 调试工具

### Console输出说明

**生成过程日志：**
```
[新生成器] 开始生成关卡 8 (种子: 42857)
[新生成器] 尝试 1: 质量分数 65.2
[新生成器] 尝试 2: 质量分数 72.8
[新生成器] 关卡 8 生成成功!
```

**关键信息：**
- 种子值可用于重现相同关卡
- 质量分数显示每次尝试的结果
- 如果100次都失败，会输出错误信息

### 手动调试单个关卡

如果某个关卡生成失败：
1. 记录Console中的警告信息
2. 使用 `DifficultyProgression.DebugPrintConfig()` 查看配置
3. 调整该关卡的难度参数
4. 重新生成单个关卡

---

## 🎯 关键改进对比

| 特性 | 旧系统 | 新系统 |
|-----|--------|--------|
| 生成策略 | 随机放置 + 验证 | 反向设计（路径→方块） |
| 方块利用 | 经常有冗余 | 精确覆盖路径 |
| 齿轮配置 | 全部启用 | 智能开关 |
| 解法质量 | 可能有多解 | 验证唯一性 |
| 质量评估 | 无 | 5维度评分 |
| 生成速度 | 快（1-3秒） | 慢但质量高（10-300秒） |
| 趣味性 | 一般 | 高（有弯曲、有挑战） |

---

## 📞 故障排除

### 问题：生成速度太慢

**原因：** 难度参数过于严格，很难找到高质量关卡

**解决：**
1. 降低质量阈值（修改 `LevelQualityEvaluator.IsHighQuality`）
2. 增加方块数量范围
3. 减少障碍物数量

### 问题：某些关卡总是生成失败

**原因：** 配置冲突（如网格太小但齿轮太多）

**解决：**
1. 使用 `DifficultyProgression.ValidateConfig()` 检查配置
2. 调整该难度段的参数
3. 跳过该关卡，手动创建

### 问题：生成的关卡太难/太简单

**原因：** 难度曲线需要微调

**解决：**
1. 修改 `DifficultyProgression.cs` 中的参数
2. 调整方块数量、网格大小、齿轮数量
3. 重新生成对应关卡段

---

## 🎓 最佳实践

### 1. 先生成小批量测试
不要一次性生成50关，先生成5-10关测试效果。

### 2. 观察质量评分
如果评分普遍低于65，说明配置需要调整。

### 3. 保存高质量关卡
记录生成高分关卡的种子值，方便复用。

### 4. 手动微调
生成后可以手动编辑LevelData进行微调。

### 5. 充分测试
每个关卡至少试玩一次，确保可玩性。

---

## 🚀 下一步

生成关卡后，你需要：

1. **添加到关卡列表**：
   - 在LevelManager的 `allLevelDatas` 列表中添加

2. **测试关卡质量**：
   - 运行游戏，测试每个关卡
   - 验证难度曲线是否合理
   - 检查是否有bug

3. **收集反馈**：
   - 让其他人试玩
   - 记录哪些关卡过难/过简单

4. **迭代优化**：
   - 根据反馈调整难度参数
   - 重新生成问题关卡

5. **打包发布**：
   - 确认所有关卡测试通过
   - Build游戏发布

---

## 🎉 总结

新的关卡生成系统虽然速度较慢，但生成的关卡质量显著提升：

✅ **更有挑战性** - 需要思考而非暴力尝试
✅ **更有趣** - 路径设计巧妙，齿轮配置精妙
✅ **无冗余** - 每个方块都不可或缺
✅ **难度渐进** - 50关平滑递增

**祝你创建出优秀的齿轮puzzle游戏！🎮✨**
