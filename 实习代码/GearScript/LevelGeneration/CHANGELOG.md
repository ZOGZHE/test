# 关卡生成系统更新日志

## 版本 1.1 - 2024-10-27

### 🎯 优化改进

#### 1. 动力/目标齿轮不再紧挨着
**问题**：之前动力齿轮和目标齿轮可能直接相邻（上下左右），导致关卡太简单，没有挑战性。

**解决方案**：
- 添加了 `IsAdjacentPosition()` 方法检查两个位置是否直接相邻
- 在放置目标齿轮时，强制检查：
  - 不能与任何动力齿轮直接相邻
  - 不能与其他目标齿轮直接相邻
  - 保持原有的最小曼哈顿距离约束

**影响**：
- 确保关卡有一定的解谜空间
- 玩家必须使用方块连接齿轮，而不是直接相邻

**修改文件**：
- `LevelGeneratorCore.cs` - `PlaceSpecialElements()` 方法
- `LevelGeneratorCore.cs` - 新增 `IsAdjacentPosition()` 方法

---

#### 2. 大幅减少单格方块使用
**问题**：单格方块（Purple06）过于简单，让解谜变得无趣，应该仅作为备用。

**解决方案**：
- 实现加权随机选择系统 `SelectWeightedBlockType()`
- 为每种方块类型设置权重：
  - **Purple06（单格）**：5% - 极低权重，仅作备用
  - **Blue01/Pink02（直线）**：各20% - 基础方块
  - **Yellow03（L形）**：25% - 最常用
  - **Orange04（T形）**：20% - 常用
  - **Green05（十字）**：10% - 复杂方块

- 修改难度系统：
  - 将单格方块从"最简单难度"移到"所有难度备用"
  - 简单关卡主要使用直线方块

**影响**：
- 关卡更有挑战性和趣味性
- 单格方块出现概率从 16.7%（1/6）降低到约 5%
- 解谜过程需要更多思考和规划

**修改文件**：
- `LevelGeneratorCore.cs` - `TryPlaceBlocksRandomly()` 方法
- `LevelGeneratorCore.cs` - 新增 `SelectWeightedBlockType()` 方法
- `BlockShapeDefinition.cs` - `GetBlockTypesForDifficulty()` 方法

---

### 📊 方块选择概率分布（新）

假设所有6种方块都可用时的选择概率：

| 方块类型 | 权重 | 概率 | 说明 |
|---------|------|------|------|
| Purple06（单格） | 0.05 | ~1% | 极少使用 |
| Blue01（横线） | 1.0 | ~21% | 常用 |
| Pink02（竖线） | 1.0 | ~21% | 常用 |
| Yellow03（L形） | 1.25 | ~26% | 最常用 |
| Orange04（T形） | 1.0 | ~21% | 常用 |
| Green05（十字） | 0.5 | ~10% | 较少用 |

**总权重：** 4.8
**单格占比：** 0.05 / 4.8 ≈ 1%（从原来的16.7%大幅降低）

---

### 🧪 测试建议

1. **重新生成关卡**：
   - 删除之前生成的测试关卡
   - 使用新版本重新生成
   - 对比新旧关卡的质量

2. **验证动力/目标分离**：
   - 在Scene中使用LevelDataGizmo可视化关卡
   - 检查动力齿轮（洋红色）和目标齿轮（青色）是否相邻
   - 应该看到它们之间至少隔着一个格子

3. **验证方块分布**：
   - 查看生成的关卡中使用的方块类型
   - 单格方块应该很少出现（平均50个方块中约1-2个）
   - L形、直线方块应该是主要类型

---

### 🔧 配置调整

如果需要进一步调整方块权重，修改 `LevelGeneratorCore.cs` 中的 `SelectWeightedBlockType()` 方法：

```csharp
case BlockType.BlockPurple06:
    weight = 0.05f;  // 调整这个值：0.0（完全禁用）到 1.0（与其他方块相同）
    break;
```

如果完全不想使用单格方块，可以设置 `weight = 0.0f`。

---

### ✅ 兼容性

这些更新完全向后兼容，不影响：
- 已有的手工创建的关卡（LevelData_1 到 LevelData_7）
- 编辑器窗口界面
- 难度曲线配置
- 其他系统功能

---

### 📝 代码质量

- 添加了详细的XML注释
- 保持代码结构清晰
- 使用有意义的变量名
- 遵循Unity C#编码规范

---

## 版本 1.0 - 2024-10-27

### 🎉 初始发布

- 完整的自动化关卡生成系统
- 支持单个和批量生成
- 50关难度递增曲线
- BFS连通性验证
- 6种方块形状支持
- Unity编辑器窗口界面

---

**更新完成！现在可以重新生成更高质量的关卡了！** 🎮✨
